let keyboard = [{
  "key": "`",
  "keyRu": "ё",
  "code": "Backquote",
},
{
  "key": "1",
  "keyRu": "1",
  "code": "Digit1",
},
{
  "key": "2",
  "keyRu": "2",
  "code": "Digit2",
}
  ,
{
  "key": "3",
  "keyRu": "3",
  "code": "Digit3",
},
{
  "key": "4",
  "keyRu": "4",
  "code": "Digit4",
}
  ,
{
  "key": "5",
  "keyRu": "5",
  "code": "Digit5",
},
{
  "key": "6",
  "keyRu": "6",
  "code": "Digit6",
},
{
  "key": "7",
  "keyRu": "7",
  "code": "Digit7",
},
{
  "key": "8",
  "keyRu": "8",
  "code": "Digit8",
},
{
  "key": "9",
  "keyRu": "9",
  "code": "Digit9",
},
{
  "key": "0",
  "keyRu": "0",
  "code": "Digit0",
},
{
  "key": "-",
  "keyRu": "-",
  "code": "Minus",
},
{
  "key": "=",
  "keyRu": "=",
  "code": "Equal",
},
{
  "key": "Backspace",
  "keyRu": "Backspace",
  "code": "Backspace",
},
{
  "key": "Tab",
  "keyRu": "Tab",
  "code": "Tab",
},
{
  "key": "q",
  "keyRu": "й",
  "code": "KeyQ",
},
{
  "key": "w",
  "keyRu": "ц",
  "code": "KeyW",
},
{
  "key": "e",
  "keyRu": "у",
  "code": "KeyE",
},
{
  "key": "r",
  "keyRu": "к",
  "code": "KeyR",
},
{
  "key": "t",
  "keyRu": "е",
  "code": "KeyT",
},
{
  "key": "y",
  "keyRu": "н",
  "code": "KeyY",
},
{
  "key": "u",
  "keyRu": "г",
  "code": "KeyU",
},
{
  "key": "i",
  "keyRu": "ш",
  "code": "KeyI",
},
{
  "key": "o",
  "keyRu": "щ",
  "code": "KeyO",
},
{
  "key": "p",
  "keyRu": "з",
  "code": "KeyP",
},
{
  "key": "[",
  "keyRu": "х",
  "code": "BracketLeft",
},
{
  "key": "]",
  "keyRu": "ъ",
  "code": "BracketRight",
},
{
  "key": "\\",
  "keyRu": "\\",
  "code": "Backslash",
},
{
  "key": "Delete",
  "keyRu": "Delete",
  "code": "Delete",
},
{
  "key": "CapsLock",
  "keyRu": "CapsLock",
  "code": "CapsLock",
},
{
  "key": "a",
  "keyRu": "ф",
  "code": "KeyA",
},
{
  "key": "s",
  "keyRu": "ы",
  "code": "KeyS",
},
{
  "key": "d",
  "keyRu": "в",
  "code": "KeyD",
},
{
  "key": "f",
  "keyRu": "а",
  "code": "KeyF",
},
{
  "key": "g",
  "keyRu": "п",
  "code": "KeyG",
},
{
  "key": "h",
  "keyRu": "р",
  "code": "KeyH",
},
{
  "key": "j",
  "keyRu": "о",
  "code": "KeyJ",
},
{
  "key": "k",
  "keyRu": "л",
  "code": "KeyK",
},
{
  "key": "l",
  "keyRu": "д",
  "code": "KeyL",
},
{
  "key": ";",
  "keyRu": "ж",
  "code": "Semicolon",
},
{
  "key": "'",
  "keyRu": "э",
  "code": "Quote",
},
{
  "key": "Enter",
  "keyRu": "Enter",
  "code": "Enter",
},
{
  "key": "Shift",
  "keyRu": "Shift",
  "code": "ShiftLeft",
},
{
  "key": "z",
  "keyRu": "я",
  "code": "KeyZ",
},
{
  "key": "x",
  "keyRu": "ч",
  "code": "KeyX",
},
{
  "key": "c",
  "keyRu": "с",
  "code": "KeyC",
},
{
  "key": "v",
  "keyRu": "м",
  "code": "KeyV",
},
{
  "key": "b",
  "keyRu": "и",
  "code": "KeyB",
},
{
  "key": "n",
  "keyRu": "т",
  "code": "KeyN",
},
{
  "key": "m",
  "keyRu": "ь",
  "code": "KeyM",
},
{
  "key": ",",
  "keyRu": "б",
  "code": "Comma",
},
{
  "key": ".",
  "keyRu": "ю",
  "code": "Period",
},
{
  "key": "/",
  "keyRu": ".",
  "code": "Slash",
},
{
  "key": "↑",
  "keyRu": "↑",
  "code": "ArrowUp",
},
{
  "key": "Shift",
  "keyRu": "Shift",
  "code": "ShiftRight",
},
{
  "key": "Ctrl",
  "keyRu": "Ctrl",
  "code": "ControlLeft",
},
{
  "key": "Meta",
  "keyRu": "Meta",
  "code": "MetaLeft",
},
{
  "key": "Alt",
  "keyRu": "Alt",
  "code": "AltLeft",
},
{
  "key": " ",
  "keyRu": " ",
  "code": "Space",
},
{
  "key": "Alt",
  "keyRu": "Alt",
  "code": "AltRight",
},
{
  "key": "←",
  "keyRu": "←",
  "code": "ArrowLeft",

},
{
  "key": "↓",
  "keyRu": "↓",
  "code": "ArrowDown",
},
{
  "key": "→",
  "keyRu": "→",
  "code": "ArrowRight",
},
{
  "key": "Ctrl",
  "keyRu": "Ctrl",
  "code": "ControlRight",
}
]


// создаю клавиатуру

const keyBoardWrapper = document.createElement('div');
keyBoardWrapper.classList.add('keyBoardWrapper');
document.body.append(keyBoardWrapper)

class Text {
  constructor() {
    this.content = '';
  }

  ap() {
    let h1 = document.createElement('h1');
    h1.classList.add('title')
    h1.innerText = this.content;
    keyBoardWrapper.append(h1);
  }
  ap3() {
    let h3 = document.createElement('h3');
    h3.classList.add('subtitle')
    h3.innerText = this.content;
    keyBoardWrapper.append(h3);
  }
}

const title = new Text();
title.content = 'RSS Виртуальная клавиатура';
title.ap();


const input = document.createElement('textarea');
input.classList.add('input');
keyBoardWrapper.append(input);

const board = document.createElement('div');
board.classList.add('board');
keyBoardWrapper.append(board);

let shh = 'down'


class KeyCreator {
  constructor() {
    this.content = '';
  }

  ap() {
    let el = document.createElement('div');
    el.classList.add('key')
    el.innerText = this.content;
    board.append(el);
  }
}




class Keyboard{
  constructor(){
    this.qqqq = [];
    for (let i=0; i < 64; i++){
      let key = new KeyCreator();
      this.qqqq.push(key)
    }
  }

  eng() {

    for (let i = 0; i < keyboard.length; i++) {
      this.qqqq[i].content = keyboard[i].key;
      this.qqqq[i].ap();

    }
  }

  ru() {
    for (let i = 0; i < keyboard.length; i++) {
      if (keyboard[i].keyRu == undefined) {
        this.qqqq[i].content = keyboard[i].key;
      } else {
        this.qqqq[i].content = keyboard[i].keyRu;
      }
      this.qqqq[i].ap();
    }
  }

}


let virtual_keyboard = new Keyboard();

let lang;
loc()


if (lang == 'eng'){
  virtual_keyboard.eng()


} else {
  virtual_keyboard.ru()


}




function loc(){
  lang = localStorage.getItem('lg');
  if (lang == null){
    lang = 'eng';
    localStorage.setItem('lg', lang);
    console.log (lang + '1')
  }else {
    localStorage.setItem('lg', lang);
    console.log (lang + '2')
  }

}



function rr () {
  board.textContent = '';
  virtual_keyboard.ru()
  lang = 'ru'
  localStorage.setItem('lg', lang);
  console.log (lang + '3')
  styles()
  addKeyCode()
  animVirt()
}
function ee () {
  board.textContent = '';
  virtual_keyboard.eng()
  lang = 'eng';
  localStorage.setItem('lg', lang);
  console.log (lang + '3')
  styles()
  addKeyCode()
  animVirt()
}



const subtitle = new Text();
subtitle.content = 'Для переключения языка комбинация: левыe ctrl + alt';
subtitle.ap3();




let flag = false;  //для capsLock виртуальной и реальной//

// реальная клавиатура


document.addEventListener('keydown', keydown);

function keydown(event){

  keyboard.forEach( elem => {
    if (elem.code == event.code) {


      // клавиша Tab на реальной клавиатуре:    
      if (elem.code == "Tab") {
        event.preventDefault()
        input.textContent = input.textContent + '    ';

      //клавиша Alt на реальной клавиатуре:  
      } else if (elem.code == "AltLeft" || elem.code == "AltRight") {
        event.preventDefault()
        input.textContent = input.textContent;

      // клавиша Ctrl на реальной клавиатуре:  
      } else if (elem.code == "ControlLeft" || elem.code == "ControlRight") {
        event.preventDefault()
        input.textContent = input.textContent;

      //клавиша Meta на реальной клавиатуре:  
      } else if (elem.code == "MetaLeft") {
        input.textContent = input.textContent + '';

      //клавиша Backspace на реальной клавиатуре:    
      } else if (elem.code == "Backspace") {
        let text = input.textContent;
        text = text.substring(0, text.length - 1);
        input.textContent = text

      //клавиша Delete на реальной клавиатуре:    
      } else if (elem.code == "Delete") {
        Delete()

      // клавиша enter на реальной клавиатуре:            
      } else if (elem.code == "Enter") {
        input.textContent += '\n'

      //клавиша Space на реальной клавиатуре:            
      } else if (elem.code == "Space") {
        input.textContent += ' '


      //клавиша Shift на реальной клавиатуре:            
      } else if (elem.code == "ShiftLeft" || elem.code == "ShiftRight") {
        event.preventDefault()
        shift()

        //клавиша CapsLock на реальной клавиатуре:            
      } else if (elem.code == "CapsLock") {
        capslock()

      } else {
        if (lang == 'eng') {
        input.textContent += elem.key;
        } else {
          input.textContent += elem.keyRu;
        }
      }

    }
  })
}      

function shift() {
  if (shh == 'down'){

    if (lang == 'eng'){
      for (let i=0; i < keys.length; i++){
        keys[i].textContent = arr[i];
        shh ='up'
      }
      for (let i=0; i < keyboard.length; i++){
        keyboard[i].key = arr[i];
        shh ='up'
      }
  
    } else if (lang == 'ru'){
      console.log (1)
      for (let i=0; i < keys.length; i++){
        keys[i].textContent = arrRu[i];
        shh ='up'
      }
      for (let i=0; i < keyboard.length; i++){
        keyboard[i].key = arrRu[i];

        shh ='up'
        
      }
    }

  } else if (shh == 'up'){

    if (lang == 'eng'){
      for (let i=0; i < keys.length; i++){
        keys[i].textContent = arrDown[i];
        shh ='down'
      }
      for (let i=0; i < keyboard.length; i++){
        keyboard[i].key = arrDown[i];
        shh ='down'
      }
  
    } else if (lang == 'ru'){
      for (let i=0; i < keys.length; i++){
        keys[i].textContent = arrRuDown[i];
        shh ='down'
      }
      for (let i=0; i < keyboard.length; i++){
        keyboard[i].key = arrRuDown[i];
        shh ='down'
      }
    }

  }

}





function capslock(){

  if (flag == false) { //если капс не был зажат
    keys.forEach(elem => {
      if (!elem.classList.contains('keyBtn')) {
        elem.textContent = elem.textContent.toUpperCase();
        flag = true;
      }
    })
  } else {
   
    keys.forEach(elem => {
      if (!elem.classList.contains('keyBtn')) {
        elem.textContent = elem.textContent.toLowerCase();
        flag = false;
      }
    })
  }
}



// переключение языка. одновременно нажатие клавиш alt +ctrl
let keys = document.querySelectorAll('.key');

function runOnKeys(func, ...codes) {
  let pressed = new Set();

  document.addEventListener('keydown', function (event) {
    pressed.add(event.code);

    for (let code of codes) {
      if (!pressed.has(code)) {
        return;
      }
    }

    pressed.clear();

    func();
  });

  document.addEventListener('keyup', function (event) {
    pressed.delete(event.code);
    keys = document.querySelectorAll('.key')
  });

}

runOnKeys(function () {

  if (lang == 'eng') {

    rr ()
    keys = document.querySelectorAll('.key')
   virtKeyAction()
   animVirt()
   addKeyCode()
    lang = 'ru'

    
  } else {

    ee ()
    keys = document.querySelectorAll('.key')
    
    virtKeyAction()
    animVirt()
    addKeyCode()
    lang = 'eng';

    
  }
  keys = document.querySelectorAll('.key')
}, "ControlLeft", "AltLeft");




        
      
      
      // функция для шифта:
      const arr = ['~', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '_', '+', "Backspace",
      "Tab",  "Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "{", "}", "|","Delete",
      "CapsLock",  "A", "S", "D", "F", "G", "H", "J", "K", "L", ":", `"`, "Enter",
      "Shift",  "Z", "X", "C", "V", "B", "N", "M", "<", ">", "?", "↑", "Shift",
       "Ctrl", "Meta", "Alt"," ","Alt", "←",  "↓", "→","Ctrl"
      ];
      const arrRu = ['Ё', '!', '"', '№', ';', '%', ':', '?', '*', '(', ')', '_', '+', "Backspace",
      "Tab",  "Й", "Ц", "У", "К", "Е", "Н", "Г", "Ш", "Щ", "З", "Х", "Ъ", "/","Delete",
      "CapsLock",  "Ф", "Ы", "В", "А", "П", "Р", "О", "Л", "Д", "Ж", `Э`, "Enter",
      "Shift",  "Я", "Ч", "С", "М", "И", "Т", "Ь", "Б", "Ю", ",", "↑", "Shift",
       "Ctrl", "Meta", "Alt"," ","Alt", "←",  "↓", "→","Ctrl"
      ];

      const arrDown = ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "Backspace",
      "Tab",  "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\","Delete",
      "CapsLock",  "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'", "Enter",
      "Shift",   "z", "x", "c", "v", "b", "n", "m", ",", ".", "/", "↑", "Shift",
       "Ctrl", "Meta", "Alt"," ","Alt", "←",  "↓", "→","Ctrl"
      ];
      const arrRuDown = ['ё', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '=', "Backspace",
      "Tab",  "й", "ц", "у", "к", "е", "н", "г", "ш", "щ", "з", "х", "ъ", "\\", "Delete",
      "CapsLock",  "ф", "ы", "в", "а", "п", "р", "о", "л", "д", "ж", `э`, "Enter",
      "Shift",  "я", "ч", "с", "м", "и", "т", "ь", "б", "ю", ".", "↑", "Shift",
       "Ctrl", "Meta", "Alt"," ","Alt", "←",  "↓", "→","Ctrl"
      ];
     




      

      // клавиши с зажатым шифтом 
      function shup(){
        if (lang == 'eng'){
          for (let i=0; i < keys.length; i++){
            keys[i].textContent = arr[i];
            shh ='up'
          }
          keyboard.forEach(elem => { elem.key = elem.key.toUpperCase() })

        } else if (lang == 'ru'){
          for (let i=0; i < keys.length; i++){
            keys[i].textContent = arrRu[i];
            shh ='up'
          }
          keyboard.forEach(elem => { elem.key = elem.key.toUpperCase() })

        }

      }

      // обычные клавиши, без шифта
      function shdown(){

        for (let i=0; i < keys.length; i++){
          if(keys[i].textContent == "Backspace" || keys[i].textContent == "Tab" || keys[i].textContent == "Delete" || keys[i].textContent == "CapsLock" || keys[i].textContent == "Enter" || keys[i].textContent == "Shift" || keys[i].textContent == "Ctrl" || keys[i].textContent == "Meta" || keys[i].textContent == "Alt"|| keys[i].textContent == "←" || keys[i].textContent == "↓" || keys[i].textContent == "→" || keys[i].textContent == "↑"){
            keys[i].textContent = keys[i].textContent;

          }
          else {
            
            if (lang == 'eng'){
            keys[i].textContent = keyboard[i].key;

            }else if (lang == 'ru'){
              if ( keyboard[i].keyRu == undefined){
                keys[i].textContent = letterLayout[i];
              } else {
                keys[i].textContent = keyboard[i].keyRu;
              }

            }  
          }
          shh ='down'
        }
      }

// виртуальная клавиатура

const letterLayout = [
  "`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=",
  "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\",
  "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'",
  "z", "x", "c", "v", "b", "n", "m", ",", ".", "/",
  'ё', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '=',
  "й", "ц", "у", "к", "е", "н", "г", "ш", "щ", "з", "х", "ъ", 
  "ф", "ы", "в", "а", "п", "р", "о", "л", "д", "ж", `э`, "\\",
  "я", "ч", "с", "м", "и", "т", "ь", "б", "ю", "."   
];


// добавляю классы для виртуальной клавиатуры

styles()
function styles() {
  const keys = document.querySelectorAll('.key');

  for (i = 0; i < keys.length; i++) {
    if (keys[i].textContent !== ' ') {
      keys[i].classList.add(`${keys[i].textContent}`)
    }
    if (!letterLayout.includes(keys[i].textContent)) {
      if (keys[i].textContent === ' ') {
        keys[i].classList.add('Space')
        keys[i].classList.add('keyBtn')
      } else {
        keys[i].classList.add(`${keys[i].textContent}`)
        keys[i].classList.add('keyBtn')
      }
    }
  }
}




// добавляю обработчики клика на виртуальные кнопки


function virtKeyAction(){
  keys.forEach(element => {

    if (element.classList.contains('keyBtn')) {
      element.addEventListener('click', function (event) {

        //клавиша Backspace на виртуальной клавиатуре:
        if (event.target.classList.contains('Backspace')) {

          let text = input.textContent;
          text = text.substring(0, text.length - 1);
          input.textContent = text
          console.log(text)

          //клавиша CapsLock на виртуальной клавиатуре:
        } else if (event.target.classList.contains('CapsLock') || event.target.classList.contains('capslock')) {

          if (flag == false) {
            keys.forEach(elem => {
              console.log(1)
              if (!elem.classList.contains('keyBtn')) {
                elem.textContent = elem.textContent.toUpperCase();
                flag = true;
              }
            })
          } else {
           
            keys.forEach(elem => {
              console.log(2)
              if (!elem.classList.contains('keyBtn')) {
                elem.textContent = elem.textContent.toLowerCase();
                flag = false;
              }
            })
          }

          //клавиша Delete на виртуальной клавиатуре:
        } else if (event.target.classList.contains('Delete')) {
          Delete()


          //клавиша enter на виртуальной клавиатуре:
        } else if (event.target.classList.contains('Enter')) {
          input.textContent += '\n'
        
          //клавиша Space на виртуальной клавиатуре:
        } else if (event.target.classList.contains('Space')) {
          input.textContent += ' '
        }

        //клавиша Alt на виртуальной клавиатуре:
        else if (event.target.classList.contains('Alt')) {
          input.textContent += ''
        }          


        //клавиша Ctrl на виртуальной клавиатуре:
        else if (event.target.classList.contains('Ctrl')) {
          input.textContent += ''

        }      

        //клавиша Tab на виртуальной клавиатуре:
        else if (event.target.classList.contains('Tab')) {
          input.textContent += '  '
        }     
        //клавиша Meta на виртуальной клавиатуре:
        else if (event.target.classList.contains('Meta')) {
          input.textContent += ''
        }  

        //клавишИ Shift на виртуальной клавиатуре:
        else if (event.target.classList.contains('Shift')) {
          if (shh == 'up'){ 
            //чтобы опустить шифт
            shdown()
          }else{
            //чтобы поднять шифт
            shup()
          } 
        }       

        else {
          
          input.textContent += element.textContent;
        }

      })
    } else {
      element.addEventListener('click', function (event) {

        input.textContent += element.textContent;

      })
    }

  });
}

virtKeyAction()



// анимация реальной клавиатуры
addKeyCode()
function addKeyCode(){
  for (let i=0; i < keys.length; i++){
    keys[i].classList.add(`${keyboard[i].code}`)
  }
}



document.addEventListener('keydown', animationKeyDown)

function animationKeyDown (event){

  for (let i=0; i<keys.length; i++){

    if( keys[i].classList.contains(`${event.code}`)){
      keys[i].classList.add('removeLetter')
    }
  }
}

document.addEventListener('keyup', animationKeyUp)

function animationKeyUp (event){
  for (let i=0; i<keys.length; i++){

    if( keys[i].classList.contains(`${event.code}`)){
      keys[i].classList.remove('removeLetter')
    }
  }
}


// анимация виртуальной клавиатуры
animVirt()
function animVirt() {
  board.addEventListener('mousedown', animationMouseDown)

  function animationMouseDown (event){
    if (event.target.classList.contains('key')){
      event.target.classList.add('removeLetter')
    }
  }

  board.addEventListener('mouseup', animationMouseUp)

  function animationMouseUp (event){
    if (event.target.classList.contains('key')){
      event.target.classList.remove('removeLetter')
    }
  }

  board.addEventListener('mouseout', animationMouseOut)

  function animationMouseOut (event){
    if (event.target.classList.contains('key')){
      event.target.classList.remove('removeLetter')
    }
  }
}



// функция для Дел

function getCaret(el) {
  if (el.selectionStart) {
    return el.selectionStart;
  } else if (document.selection) {
    el.focus();

    let r = document.selection.createRange();
    if (r == null) {
      return 0;
    }

    let re = el.createTextRange(),
      rc = re.duplicate();
    re.moveToBookmark(r.getBookmark());
    rc.setEndPoint("EndToStart", re);

    return rc.text.length;
  }
  return 0;
}

function resetCursor(txtElement, currentPos) {
  if (txtElement.setSelectionRange) {
    txtElement.focus();
    txtElement.setSelectionRange(currentPos, currentPos);
  } else if (txtElement.createTextRange) {
    var range = txtElement.createTextRange();
    range.moveStart("character", currentPos);
    range.select();
  }
}

function Delete() {
  let currentPos = getCaret(input);
  console.log(getCaret(input));
  let text = input.textContent;
  let backSpace = text.substr(0, currentPos) + text.substr(currentPos + 1, text.length);
  input.textContent = backSpace;
  resetCursor(input, currentPos);
}
